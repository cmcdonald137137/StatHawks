---
title: "Cade_Model"
author: "Cade McDonald"
date: "2023-11-10"
output: html_document
---
```{r}
# Install and load the haven package if not already installed
if (!requireNamespace("dplyr", quietly = TRUE)) {
    install.packages("hdplyr", dependencies = TRUE)
}
if (!requireNamespace("haven", quietly = TRUE)) {
    install.packages("haven", dependencies = TRUE)
}
library(dplyr)
library(haven)

# Specify the paths to your XPT files

path_p_heq <- "C:/Users/cadej/OneDrive - University of Iowa/Documents/Nhanes Datathon Project/P_HEQ.XPT"
path_p_imq <- "C:/Users/cadej/OneDrive - University of Iowa/Documents/Nhanes Datathon Project/P_IMQ.XPT"
path_p_demo <- "C:/Users/cadej/OneDrive - University of Iowa/Documents/Nhanes Datathon Project/P_DEMO.XPT"

p_heq <- haven::read_xpt(path_p_heq)
p_imq <- haven::read_xpt(path_p_imq)
p_demo <- haven::read_xpt(path_p_demo)
# Combine the datasets based on the SEQN column
# You can use the merge function or dplyr's left_join function
combined_data <- merge(merge(p_heq, p_imq, by = "SEQN", all.x = TRUE), p_demo, by = "SEQN", all.x = TRUE)

# Filter the combined data
filtered_data <- combined_data %>%
  filter(!is.na(HEQ010))


# Print the first few rows of the filtered data
head(filtered_data)

# Print the first few rows of the combined dataset
head(combined_data)



# Read in the XPT files
path_p_heq_67 <-  "C:/Users/cadej/OneDrive - University of Iowa/Documents/Nhanes Datathon Project/HEQ_I_201617.XPT"
path_p_imq_67<- "C:/Users/cadej/OneDrive - University of Iowa/Documents/Nhanes Datathon Project/IMQ_I_201617.XPT"
path_p_demo_67 <- "C:/Users/cadej/OneDrive - University of Iowa/Documents/Nhanes Datathon Project/DEMO_I_201617.XPT"
p_heq_67 <- haven::read_xpt(path_p_heq_67)
p_imq_67 <- haven::read_xpt(path_p_imq_67)
p_demo_67 <- haven::read_xpt(path_p_demo_67)
# Combine the datasets based on the SEQN column
# You can use the merge function or dplyr's left_join function
combined_data_67 <- merge(merge(p_heq_67, p_imq_67, by = "SEQN", all.x = TRUE), p_demo_67, by = "SEQN", all.x = TRUE)

# Filter the combined data
filtered_data_67 <- combined_data_67 %>%
  filter(!is.na(HEQ010))

# Print the first few rows of the filtered data
head(filtered_data_67)

# Print the first few rows of the combined dataset
head(combined_data_67)
length(combined_data_67)
length(combined_data)

# Assuming combined_data_67 and combined_data have the same structure

# Assuming combined_data_67 and combined_data have the same structure
```

```{r}

# Identify common columns
common_columns <- intersect(names(combined_data_67), names(combined_data))

# Add missing rows using bind_rows
combined_data_full <- bind_rows(
  select(combined_data_67, all_of(common_columns)),
  select(combined_data, all_of(common_columns))
)

combined_data_full <- combined_data_full

# View the first few rows of the final combined dataset
combined_data_full <- dplyr::select(combined_data_full, -RIDAGEMN) #all na's

combined_data_full <- dplyr::select(combined_data_full, -HEQ040, -HEQ030) #hepatitis C Measure
combined_data_full <- dplyr::select(combined_data_full, -IMQ011, -IMQ070, -IMQ060, -IMQ090, -IMQ100, -DMDBORN4)
combined_data_full <- dplyr::select(combined_data_full, -FIAPROXY, -FIAINTRP, -MIALANG, -MIAPROXY, -FIALANG, -SIAPROXY, -SIAINTRP, -MIAINTRP, -AIALANGA, -RIDEXPRG, -RIDRETH1, -SIALANG, -RIDEXMON)
#HepA, HPVF, HPVM, age first hpv dose, Received HPV Doses 
combined_data_full$HEQ010 <- ifelse(combined_data_full$HEQ010 == 1, 1, 0)
# Bad Predictor: SDDSRVYR, RIDSTATR, RIDAGEMN(Less than 25 months old), RIDEXAGM(less than 240 months old), 
# MDBORN4(country born in), DMDCITZN( citizenship status), SIAPROXY: Proxy respondant, FIALANG: language used in home,
#Bad: FIAPROXY: proxy resident used in family interview, FIAINTRP: interpreter used, MIALANG: Language english or spanish, MIAPROXY: proxy respondent used udring the CPAI portion of the MEC interview, 
#Questional predictors: DMDMARTL(Marital Status), RIDEXPRG(Pregnancy Status), DMDYRSUS(years lived in the USA),DMQMILIZ: Military Status, DMQADFC: Active duty serving, SIALANG: language used
#Okay: DMDEDUC3: 6-19 year old education level, DMDEDUC2:20 or older education level, INDFMPIR: family income to poverty. 
combined_data_full 
# Filter the combined data
#filtered_data_full <- combined_data_full %>%
  #filter(!is.na(HEQ010))
#filtered_data_full
missing_counts <- colSums(is.na(combined_data_full))

# Display the counts of missing values for each column

#SEQN ID Number
#HEQ010 Ever told if had HEPB
#HEQ020 Ever diagnosed HEPB Drugs
#IMQ020 HEPB Vaccination Status
#SDDSRVYR Data release cycle
#RIDSTATR Interview Status
#RIAGENDR Gender 1=male 2= female
#RIDAGEYR age at screening
#RIDRETH1 RACE, asian not included, RIDRETH3 RACE asian included take out ridreth1
#RIDEXMON - Six month time period 1	November 1 through April 30 2	May 1 through October 31 #BAD PREDICTOR
#DMDEDUC2 Education level adults 20+ 
#SDMVPSU - Masked variance pseudo-PSU
#SDMVSTRA - Masked variance pseudo-stratum
#INDFMPIR - Ratio of family income to poverty 0 to 4.99	Range of Values 5	Value greater than or equal to 5.00 .	Missing
# Specify the variables to be converted to factors
factor_vars <- c("HEQ010", "HEQ020", "IMQ020", "SDDSRVYR", "RIDSTATR", "RIAGENDR", "RIDRETH3", "DMDEDUC2")

# Convert the specified variables to factors
combined_data_full[factor_vars] <- lapply(combined_data_full[factor_vars], factor)

# Verify the changes
str(combined_data_full)
``` 


```{r}
# Assuming combined_data_full is your dataset
if (!requireNamespace("mice", quietly = TRUE)) {
  install.packages("mice")
}
library(mice)

# Impute missing values
imputed_data <- complete(mice(combined_data_full))

# Calculate the correlation matrix
correlation_matrix <- cor(imputed_data, use = "complete.obs")

if (!requireNamespace("corrplot", quietly = TRUE)) {
  install.packages("corrplot")
}
library(corrplot)

# Plot the correlation matrix
corrplot(correlation_matrix, method = "color")

```

```{r}
library(glmnet)
```

```{r}
# Specify the columns to be excluded
exclude_columns <- c('SEQN', "SDDSRVYR", "RIDSTATR", "SDMVPSU", "SDMVSTRA")

# Create a new data frame excluding the specified columns
dfm <- combined_data_full[, !(names(combined_data_full) %in% exclude_columns)]

# Verify the changes
str(dfm)
```
```{r}
set.seed(5400)

# Create train and test subsets
train_index <- sample(1:nrow(dfm), 0.7 * nrow(dfm))
train_dfm <- dfm[train_index, ]
test_dfm <- dfm[-train_index, ]
levels(train_dfm$IMQ020)
levels(test_dfm$IMQ020)
# Ensure that levels in test set match levels in training set
test_dfm$IMQ020 <- factor(test_dfm$IMQ020, levels = levels(train_dfm$IMQ020))
# Specify the variables
selected_vars <- c("HEQ020", "IMQ020", "RIAGENDR", "RIDRETH3", "DMDEDUC2", "INDFMPIR", "RIDAGEYR")

# Check if all selected variables are present in dfm
missing_vars <- setdiff(selected_vars, colnames(dfm))

if (length(missing_vars) > 0) {
  stop(paste("The following variables are missing in dfm:", paste(missing_vars, collapse = ", ")))
}

# Convert response variable to factor with 2 levels
train_dfm$HEQ010 <- as.factor(train_dfm$HEQ010)
test_dfm$HEQ010 <- as.factor(test_dfm$HEQ010)

# Fit logistic regression model on the training set
logit_model <- glm(HEQ010 ~ ., data = train_dfm[, c("HEQ010", selected_vars), drop = FALSE], family = "binomial")

# Predict on the test set
test_probabilities <- predict(logit_model, newdata = test_dfm, type = "response")

# Convert probabilities to binary predictions
test_predictions <- ifelse(test_probabilities > 0.5, 1, 0)

# Evaluate the model (you can replace this with your specific evaluation metric)
# For example, you can use accuracy
accuracy <- mean(test_predictions == as.numeric(test_dfm$HEQ010))

# Display the accuracy
cat("Accuracy on Test Set:", accuracy, "\n")

# Display summary of the logistic regression model
summary(logit_model)

```
# convert factor variables to dummies

# # Loop through each variable to check if it is a factor for training dataset
```{r}
dummy_df <- data.frame()

for (col in names(dfm)) {
  if (is.factor(dfm[[col]])) {
    # Replace missing values with a placeholder (e.g., "NA")
    dfm[[col]] <- as.character(dfm[[col]])
    dfm[[col]][is.na(dfm[[col]])] <- "NA"
    
    # Create dummy variables
    dummies <- model.matrix(~ dfm[[col]] - 1)
    
    # Check the dimensions of the dummy variables
    if (ncol(dummies) > 0) {
      # Extract dummy variable columns
      dummy_cols <- dummies[, -1, drop = FALSE]
      
      # Bind the dummy variables to the dummy dataframe
      dummy_df <- cbind(dummy_df, dummy_cols)
    }
    
    # Drop the original factor column
    dfm[[col]] <- NULL
  }
}

# Bind the dummy dataframe to the original dataframe
dfm <- cbind(dfm, dummy_df)

# Ensure the number of rows match
n_rows_original <- nrow(dfm)
n_rows_dummy <- nrow(dummy_df)

# Check if the number of rows match
if (n_rows_original != n_rows_dummy) {
  stop("Number of rows in dummy variables does not match the original dataframe.")
}


# Ensure the number of rows match
n_rows_original <- nrow(dfm)
n_rows_dummy <- nrow(dummies)

# Check if the number of rows match
if (n_rows_original != n_rows_dummy) {
  stop("Number of rows in dummy variables does not match the original dataframe.")
}

# Split the data into training and testing sets
set.seed(5400)
train_index <- sample(1:nrow(dfm), 0.7 * nrow(dfm))
train_dfm <- dfm[train_index, ]
test_dfm <- dfm[-train_index, ]

# Prepare the data for the HEQ010 model
train <- train_dfm
test <- test_dfm
head(train)
```


```{r}
if (!requireNamespace("caret", quietly = TRUE)) {
  install.packages("caret")
}
library(caret)
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  install.packages("ggplot2")
}
library(ggplot2)
if (!requireNamespace("lattice", quietly = TRUE)) {
  install.packages("lattice")
}
library(lattice)
cor_matrix <- cor(train[, -which(names(train) == "HEQ010")])
high_corr_pairs <- findCorrelation(cor_matrix, cutoff = 0.8)
```

```{r}
#cor_matrix
#high_corr_pairs
zero_sd_vars <- sapply(train, function(x) sd(x, na.rm = TRUE)) == 0
print(names(zero_sd_vars)[zero_sd_vars])
```

```{r}
# Train the glm model for HEQ010 
log_model <- glm(HEQ010 ~ ., family = binomial(link = "logit"), data = train, maxit = 10000000000)
# Evaluate the model on the new test subset
log_pred_HEQ010_test <- predict(log_model, newdata = test, type = "response")
test$HEQ010 <- ifelse(log_pred_HEQ010_test > 0.5, 1, 0)

# Calculate accuracy for the 'HEQ010 ' binary classification
actual_HEQ010  <- test_dfm$HEQ010 
predicted_HEQ010  <- test_dfm$HEQ010 
accuracy_HEQ010  <- mean(actual_HEQ010  == predicted_HEQ010 )
print(paste("Accuracy for 'HEQ010 ':", accuracy_HEQ010 ))
```

